<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Processing Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .processing-bar {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-badge {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-video text-3xl"></i>
                    <div>
                        <h1 class="text-3xl font-bold">Video Processing Dashboard</h1>
                        <p class="text-blue-100">AI-Powered Video Enhancement Workflow</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div id="system-status" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full status-badge"></div>
                        <span class="text-sm">System Online</span>
                    </div>
                    <button onclick="toggleConfig()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="max-w-7xl mx-auto px-8 pt-4">
                {% for message in messages %}
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded-r-lg">
                        <p>{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-8 py-8">
        <!-- Processing Status Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">
                    <i class="fas fa-chart-line text-blue-600 mr-3"></i>Processing Status
                </h2>
                <div id="processing-indicator" class="flex items-center space-x-2">
                    {% if processing_status.is_processing %}
                        <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
                        <span class="text-orange-600 font-medium">Processing...</span>
                    {% else %}
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-green-600 font-medium">Ready</span>
                    {% endif %}
                </div>
            </div>

            <div id="progress-section" {% if not processing_status.is_processing %}style="display: none;"{% endif %}>
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span id="current-stage">{{ processing_status.stage }}</span>
                        <span id="progress-percent">{{ processing_status.progress }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="processing-bar h-3 rounded-full transition-all duration-500" 
                             style="width: {{ processing_status.progress }}%"></div>
                    </div>
                </div>
                <div id="current-file" class="text-gray-700">
                    {% if processing_status.current_file %}
                        Processing: <span class="font-medium">{{ processing_status.current_file }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Real-time Logs -->
            <div class="mt-6">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Activity Log</h3>
                <div id="log-container" class="bg-gray-900 text-green-400 p-4 rounded-lg h-32 overflow-y-auto font-mono text-sm">
                    <div id="logs">
                        {% for log in processing_status.logs %}
                            <div class="log-entry">{{ log.timestamp }} - {{ log.message }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Files Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-cloud-upload-alt text-blue-600 mr-3"></i>Input Videos
                    </h2>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        {{ input_files|length }} files
                    </span>
                </div>

                <!-- Upload Area -->
                <div class="mb-6">
                    <form action="/upload" method="post" enctype="multipart/form-data" class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-all">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-4">Drag & drop videos here or click to browse</p>
                        <input type="file" name="file" accept=".mp4,.avi,.mov,.mkv" class="hidden" id="file-input" onchange="this.form.submit()">
                        <label for="file-input" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg cursor-pointer transition-colors">
                            Choose File
                        </label>
                        <p class="text-xs text-gray-500 mt-2">MP4, AVI, MOV, MKV files supported</p>
                    </form>
                </div>

                <!-- File List -->
                <div class="space-y-3">
                    {% for file in input_files %}
                        <div class="file-card bg-gray-50 p-4 rounded-lg border border-gray-200 transition-all">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-file-video text-blue-600"></i>
                                    <div>
                                        <p class="font-medium text-gray-900">{{ file }}</p>
                                        <p class="text-sm text-gray-500">Video file</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="processVideo('{{ file }}')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                                            {% if processing_status.is_processing %}disabled{% endif %}>
                                        <i class="fas fa-play mr-1"></i>Process
                                    </button>
                                    <button onclick="deleteFile('input', '{{ file }}')"
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>No input videos yet</p>
                            <p class="text-sm">Upload a video to get started</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Output Files Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-download text-green-600 mr-3"></i>Processed Videos
                    </h2>
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        {{ output_files|length }} files
                    </span>
                </div>

                <div class="space-y-3">
                    {% for file in output_files %}
                        <div class="file-card bg-gray-50 p-4 rounded-lg border border-gray-200 transition-all">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-file-video text-green-600"></i>
                                    <div>
                                        <p class="font-medium text-gray-900">{{ file }}</p>
                                        <p class="text-sm text-gray-500">Processed video</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <a href="/view/{{ file }}" target="_blank"
                                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </a>
                                    <a href="/download/{{ file }}"
                                       class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </a>
                                    <button onclick="deleteFile('output', '{{ file }}')"
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-clock text-4xl mb-4"></i>
                            <p>No processed videos yet</p>
                            <p class="text-sm">Process some input videos to see results</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Caption Files Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-pen-fancy text-purple-600 mr-3"></i>Generated Captions
                    </h2>
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        {{ caption_files|length }} files
                    </span>
                </div>

                <div class="space-y-3">
                    {% for file in caption_files %}
                        <div class="file-card bg-gray-50 p-4 rounded-lg border border-gray-200 transition-all">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-file-alt text-purple-600"></i>
                                    <div>
                                        <p class="font-medium text-gray-900">{{ file }}</p>
                                        <p class="text-sm text-gray-500">Social media caption</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="viewCaption('{{ file }}')"
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button onclick="copyCaption('{{ file }}')"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                    <button onclick="deleteFile('caption', '{{ file }}')"
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-pen text-4xl mb-4"></i>
                            <p>No captions generated yet</p>
                            <p class="text-sm">Process videos to generate captions</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">Configuration Settings</h3>
                        <button onclick="toggleConfig()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="config-content" class="space-y-4">
                        <pre class="bg-gray-100 p-4 rounded-lg text-sm overflow-auto">{{ config | tojson(indent=2) }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Caption Modal -->
    <div id="caption-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">Generated Caption</h3>
                        <button onclick="closeCaptionModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Caption:</label>
                        <textarea id="caption-text" class="w-full p-4 border border-gray-300 rounded-lg resize-none h-64 focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeCaptionModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                            Close
                        </button>
                        <button onclick="copyCaptionText()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-copy mr-2"></i>Copy Caption
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize WebSocket connection
        const socket = io();

        // Update processing status in real-time
        socket.on('progress_update', function(data) {
            console.log('Progress update received:', data);
            updateProgressDisplay(data.status);
            if (data.logs && data.logs.length > 0) {
                appendLogs(data.logs);
            }
        });

        socket.on('processing_complete', function(status) {
            console.log('Processing complete:', status);
            updateProgressDisplay(status);
            
            // Re-enable all process buttons
            const processButtons = document.querySelectorAll('button[onclick*="processVideo"]');
            processButtons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play mr-1"></i>Process';
            });
            
            setTimeout(() => {
                location.reload(); // Refresh to show new output files
            }, 3000);
        });

        socket.on('connect', function() {
            console.log('WebSocket connected');
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });

        function updateProgressDisplay(status) {
            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const currentStage = document.getElementById('current-stage');
            const currentFile = document.getElementById('current-file');
            const indicator = document.getElementById('processing-indicator');

            if (status.is_processing) {
                progressSection.style.display = 'block';
                progressBar.style.width = status.progress + '%';
                progressPercent.textContent = status.progress + '%';
                currentStage.textContent = status.stage;
                currentFile.innerHTML = status.current_file ? 
                    `Processing: <span class="font-medium">${status.current_file}</span>` : '';
                
                indicator.innerHTML = `
                    <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
                    <span class="text-orange-600 font-medium">Processing...</span>
                `;
            } else {
                progressSection.style.display = 'none';
                indicator.innerHTML = `
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-green-600 font-medium">Ready</span>
                `;
            }
        }

        function appendLogs(logs) {
            const logContainer = document.getElementById('logs');
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = `${log.timestamp} - ${log.message}`;
                logContainer.appendChild(logEntry);
            });
            // Auto-scroll to bottom
            const logParent = logContainer.parentElement;
            logParent.scrollTop = logParent.scrollHeight;
        }

        function processVideo(filename) {
            // Show immediate feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Starting...';
            button.disabled = true;
            
            fetch(`/process/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                        button.innerHTML = originalText;
                        button.disabled = false;
                    } else {
                        console.log('Processing started:', data.message);
                        // Button will be re-enabled when processing completes
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to start processing');
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
        }

        function deleteFile(type, filename) {
            if (confirm(`Are you sure you want to delete ${filename}?`)) {
                window.location.href = `/delete/${type}/${encodeURIComponent(filename)}`;
            }
        }

        function toggleConfig() {
            const modal = document.getElementById('config-modal');
            modal.classList.toggle('hidden');
        }

        function viewCaption(filename) {
            fetch(`/view_caption/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('caption-text').value = data.caption;
                        document.getElementById('caption-modal').classList.remove('hidden');
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching caption:', error);
                    alert('Failed to fetch caption');
                });
        }

        function copyCaption(filename) {
            fetch(`/view_caption/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        navigator.clipboard.writeText(data.caption).then(() => {
                            alert('Caption copied to clipboard!');
                        }).catch(err => {
                            console.error('Failed to copy caption:', err);
                            alert('Failed to copy caption to clipboard.');
                        });
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching caption:', error);
                    alert('Failed to fetch caption');
                });
        }

        function closeCaptionModal() {
            document.getElementById('caption-modal').classList.add('hidden');
            document.getElementById('caption-text').value = ''; // Clear text area
        }

        // Auto-refresh status every 30 seconds
        setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(status => updateProgressDisplay(status))
                .catch(error => console.error('Status update failed:', error));
        }, 30000);
    </script>
</body>
</html> 